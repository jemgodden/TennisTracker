from datetime import datetime
import pandas as pd
import streamlit as st
from streamlit_extras.switch_page_button import switch_page

from src.tennis import Match
from src.utils import create_backend_df


# Application page - 'Load Match':
# Let user load a previously created match data csv file and set appropriate session state variables.


if __name__ == "__main__":

    st.set_page_config(
        page_title="Load Match",
        page_icon=":floppy_disk:",
        layout='wide',
        # initial_sidebar_state="collapsed",
    )

    st.title("Load a Previous Match :floppy_disk:")

    with st.container("Upload Data"):
        st.header("Upload a File")

        uploaded_file = st.file_uploader(
            "Choose a CSV file",
            type=['csv'],
            accept_multiple_files=False
        )
        if uploaded_file:
            try:
                match_data = pd.read_csv(uploaded_file)
            except:
                st.error("File is not compatible. Please make sure you are uploading a file generated by this application.")
                st.stop()

            temp_backend_df = create_backend_df()
            if match_data.columns.values.shape[0] != temp_backend_df.columns.values.shape[0] \
                    or match_data.columns.values != temp_backend_df.columns.values:
                st.error("File is not compatible. Please make sure you are uploading a file generated by this application.")
                st.stop()

            st.session_state['match_data'] = match_data
            st.session_state['match'] = Match()
            st.session_state['match_datetime'] = match_data['meta_match_datetime'].iloc[0]
            st.session_state['player1_name'] = match_data['meta_player1_name'].iloc[0]
            st.session_state['player2_name'] = match_data['meta_player2_name'].iloc[0]

        st.caption("Note that loading a file will overwrite any previous information added in the 'New Match' page.  \nConsider saving the file first.")

    with st.container("Page Navigation"):
        st.write("###")
        st.divider()
        left, right = st.columns(2)
        if left.button("Continue Tracking Match"):
            switch_page("Track Match")
        if right.button("Analyse Loaded Match"):
            switch_page("Analyse Match")
